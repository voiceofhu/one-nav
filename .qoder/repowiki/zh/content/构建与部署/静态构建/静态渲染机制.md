# 静态渲染机制

<cite>
**本文档中引用的文件**  
- [page.tsx](file://src/app/(main)/page.tsx)
- [layout.tsx](file://src/app/layout.tsx)
- [data.json](file://data.json)
- [package.json](file://package.json)
</cite>

## 目录

1. [项目结构分析](#项目结构分析)
2. [核心数据源分析](#核心数据源分析)
3. [静态渲染机制详解](#静态渲染机制详解)
4. [布局文件与SEO元数据注入](#布局文件与seo元数据注入)
5. [本地JSON数据读取与静态生成示例](#本地json数据读取与静态生成示例)
6. [动态路由静态化策略](#动态路由静态化策略)
7. [数据源缺失风险与应对方案](#数据源缺失风险与应对方案)

## 项目结构分析

本项目采用Next.js 15 App Router架构，遵循功能模块化组织方式。核心页面位于`src/app/(main)/page.tsx`，布局文件为`src/app/layout.tsx`，全局样式定义于`globals.css`。静态资源存放在`public`目录，组件库位于`src/components`，工具函数与请求封装在`src/lib`中。

项目根目录下的`data.json`作为静态数据源，用于构建时注入页面内容。`package.json`中定义了构建脚本与SEO元数据配置，支持Turbopack加速开发与构建流程。

```mermaid
graph TB
subgraph "应用层"
Page["page.tsx"]
Layout["layout.tsx"]
end
subgraph "资源层"
Data["data.json"]
Public["public/"]
Package["package.json"]
end
Page --> Data : "构建时读取"
Layout --> Package : "读取SEO配置"
Page --> Layout : "嵌套渲染"
```

**图示来源**

- [page.tsx](<file://src/app/(main)/page.tsx>)
- [layout.tsx](file://src/app/layout.tsx)
- [data.json](file://data.json)
- [package.json](file://package.json)

**本节来源**

- [src/app/page.tsx](<file://src/app/(main)/page.tsx>)
- [src/app/layout.tsx](file://src/app/layout.tsx)
- [data.json](file://data.json)

## 核心数据源分析

`data.json`文件存储了VPS服务提供商BandwagonHost的套餐信息，包含平台标识、套餐名称、CPU、内存、磁盘、流量、带宽、数据中心、年费价格、测试地址、库存状态和购买链接等字段。该文件作为静态数据源，在构建时被读取并注入到页面中。

数据结构以数组形式组织，每个对象代表一个VPS套餐，通过`platform`字段区分不同平台（当前均为`bwg`）。`stock_status`字段指示库存状态，可用于前端展示售罄或可购状态。

```json
[
  {
    "platform": "bwg",
    "plan_name": "日本东京限量版",
    "cpu": "1核",
    "ram": "1GB",
    "disk": "20GB",
    "monthly_traffic": "500GB",
    "bandwidth": "2.5Gbps",
    "data_center": "日本东京 DC39v2，三网直连",
    "price_per_year": "$79",
    "test_address": "https://dc39.bwg.net",
    "stock_status": false,
    "purchase_link": "https://www.bandwagonhost.net/1215.html"
  }
]
```

**图示来源**

- [data.json](file://data.json)

**本节来源**

- [data.json](file://data.json)

## 静态渲染机制详解

Next.js 15 App Router通过`generateStaticParams`函数实现动态路由的静态生成。虽然当前`page.tsx`未使用动态路由，但其静态渲染机制仍可通过`generateStaticParams`扩展支持多页面生成。

`generateStaticParams`应在动态路由段中使用，返回一组参数对象，Next.js将为每个参数组合预渲染对应页面。对于当前首页，若未来需基于`data.json`生成多个套餐详情页，则可在`app/[plan]/page.tsx`中实现：

```ts
export async function generateStaticParams() {
  const data = await fetch(`${process.cwd()}/data.json`);
  const plans = await data.json();
  return plans.map((plan) => ({
    plan: plan.plan_name,
  }));
}
```

注意：当前`page.tsx`仅返回简单JSX，未实现数据读取逻辑，需在实际开发中补充。

**本节来源**

- [page.tsx](<file://src/app/(main)/page.tsx>)
- [data.json](file://data.json)

## 布局文件与SEO元数据注入

`layout.tsx`文件定义了应用的根布局，通过`metadata`对象注入SEO元数据。这些元数据来源于`package.json`中的`seo`字段，实现了配置与代码分离。

`metadata`包含标题、描述、关键词、Open Graph和Twitter卡片信息，并通过`metadataBase`指定元数据基准URL。此外，通过`Script`组件注入JSON-LD结构化数据，提升搜索引擎理解能力。

```ts
export const metadata: Metadata = {
  title: pkg.seo.title,
  description: pkg.seo.description,
  keywords: pkg.seo.keywords,
  openGraph: {
    title: pkg.seo.og.title,
    description: pkg.seo.og.description,
    url: pkg.seo.og.url,
    type: pkg.seo.og.type as 'website',
    images: pkg.seo.og.image,
  },
  twitter: {
    card: pkg.seo.twitter.card as 'summary_large_image',
    title: pkg.seo.twitter.title,
    description: pkg.seo.twitter.description,
    images: pkg.seo.twitter.image,
  },
  metadataBase: new URL(pkg.seo.og.url),
};
```

**图示来源**

- [layout.tsx](file://src/app/layout.tsx)
- [package.json](file://package.json)

**本节来源**

- [layout.tsx](file://src/app/layout.tsx)
- [package.json](file://package.json)

## 本地JSON数据读取与静态生成示例

在Next.js构建时，可通过`fs`模块读取本地JSON文件并生成静态页面。以下为示例代码：

```ts
import fs from 'fs';
import path from 'path';

// 读取本地数据
async function getPlans() {
  const filePath = path.join(process.cwd(), 'data.json');
  const fileContent = fs.readFileSync(filePath, 'utf8');
  return JSON.parse(fileContent);
}

// 在页面组件中使用
export default async function Page() {
  const plans = await getPlans();
  return (
    <div>
      {plans.map((plan, index) => (
        <div key={index}>
          <h2>{plan.plan_name}</h2>
          <p>价格: {plan.price_per_year}</p>
          <p>库存: {plan.stock_status ? '有货' : '售罄'}</p>
        </div>
      ))}
    </div>
  );
}
```

此模式确保所有数据在构建时被捕获，生成完全静态的HTML文件，提升加载性能与SEO效果。

**本节来源**

- [page.tsx](<file://src/app/(main)/page.tsx>)
- [data.json](file://data.json)

## 动态路由静态化策略

为实现基于`data.json`的动态页面生成，应创建动态路由段如`app/plans/[name]/page.tsx`，并在其中实现`generateStaticParams`：

```ts
// app/plans/[name]/page.tsx
import { notFound } from 'next/navigation';

export async function generateStaticParams() {
  const plans = await getPlans();
  return plans.map((plan) => ({
    name: encodeURIComponent(plan.plan_name),
  }));
}

export default async function PlanPage({ params }: { params: { name: string } }) {
  const decodedName = decodeURIComponent(params.name);
  const plans = await getPlans();
  const plan = plans.find((p) => p.plan_name === decodedName);

  if (!plan) {
    notFound();
  }

  return (
    <div>
      <h1>{plan.plan_name}</h1>
      <p>配置: {plan.cpu}, {plan.ram}, {plan.disk}</p>
      <p>价格: {plan.price_per_year}</p>
    </div>
  );
}
```

此策略确保所有套餐页面在构建时被预渲染，实现最佳性能与SEO。

**本节来源**

- [data.json](file://data.json)

## 数据源缺失风险与应对方案

当`data.json`文件缺失或格式错误时，构建过程将失败。为应对该风险，建议采取以下措施：

1. **构建前验证**：在`package.json`的`build`脚本中添加数据验证步骤
2. **默认数据回退**：提供默认数据文件作为备用
3. **错误处理**：在数据读取函数中添加try-catch块
4. **CI/CD检查**：在持续集成流程中验证数据文件完整性

```ts
async function getPlans() {
  try {
    const filePath = path.join(process.cwd(), 'data.json');
    const fileContent = fs.readFileSync(filePath, 'utf8');
    const data = JSON.parse(fileContent);

    // 验证数据结构
    if (!Array.isArray(data)) {
      throw new Error('data.json must contain an array');
    }
    return data;
  } catch (error) {
    console.warn('Failed to read data.json, using fallback data:', error);
    return []; // 或返回默认数据
  }
}
```

通过以上措施，可确保构建过程的稳定性，避免因数据问题导致部署失败。

**本节来源**

- [data.json](file://data.json)
- [package.json](file://package.json)
