# 服务器配置

<cite>
**Referenced Files in This Document**   
- [next.config.ts](file://next.config.ts)
- [package.json](file://package.json)
- [dist/404.html](file://dist/404.html)
- [dist/_next/static/chunks/981a7b3ba1dfa6bd.css](file://dist/_next/static/chunks/981a7b3ba1dfa6bd.css)
- [dist/_next/static/chunks/9dd01691f16dbfdc.js](file://dist/_next/static/chunks/9dd01691f16dbfdc.js)
- [dist/_next/static/chunks/504003311425f84c.js](file://dist/_next/static/chunks/504003311425f84c.js)
- [dist/_next/static/chunks/0bae3126c2213363.js](file://dist/_next/static/chunks/0bae3126c2213363.js)
- [dist/_next/static/chunks/c78cbca517c49699.js](file://dist/_next/static/chunks/c78cbca517c49699.js)
</cite>

## 目录

1. [项目结构分析](#项目结构分析)
2. [构建与导出配置](#构建与导出配置)
3. [Nginx 部署配置](#nginx-部署配置)
4. [Apache 部署配置](#apache-部署配置)

## 项目结构分析

项目 `one-nav` 是一个基于 Next.js 15 的静态站点应用，采用 App Router 架构。其核心结构如下：

- `src/app` 目录包含应用的路由和页面，主要入口为 `(main)/page.tsx`。
- `public` 目录存放静态资源，如 `manifest.json`、`popup.html` 等。
- `dist` 目录是构建后的输出目录，包含所有静态文件。

通过 `pnpm run build` 命令，项目会生成一个完全静态的网站，所有文件都位于 `dist` 目录下，可以直接部署到任何静态文件服务器上。

**Section sources**

- [next.config.ts](file://next.config.ts)
- [package.json](file://package.json)

## 构建与导出配置

### next.config.ts 配置分析

`next.config.ts` 文件中的配置决定了应用如何被构建和导出。

```typescript
const nextConfig: NextConfig = {};

switch (process.env.NODE_ENV) {
  case 'production':
    nextConfig.output = 'export';
    nextConfig.images = {};
    nextConfig.images.unoptimized = true;
    nextConfig.distDir = 'dist';
    break;
  case 'development':
    nextConfig.rewrites = proxy;
    break;
}

export default nextConfig;
```

**关键配置项解释：**

- **`output: 'export'`**: 这是静态导出的核心配置。当设置为 `'export'` 时，Next.js 会将应用构建为一个完全静态的网站，生成 `dist` 目录下的所有 HTML、CSS 和 JavaScript 文件。这使得应用可以部署在任何静态文件服务器（如 Nginx、Apache）上，而无需 Node.js 运行时。
- **`images.unoptimized: true`**: 由于静态站点无法在运行时动态优化图片，此配置会禁用 Next.js 的图片优化功能，直接使用 `public` 目录中的原始图片。
- **`distDir: "dist"`**: 指定构建输出目录为 `dist`，这是部署时需要复制的目录。

**Section sources**

- [next.config.ts](file://next.config.ts#L15-L25)

### package.json 构建脚本分析

`package.json` 文件定义了构建流程。

```json
{
  "scripts": {
    "dev": "next dev --turbopack",
    "build": "next build --turbopack",
    "build:ext": "npm run build && node scripts/build-ext.mjs"
  }
}
```

- **`"build"`**: 执行 `next build --turbopack`。`--turbopack` 是一个更快的构建引擎。此命令会读取 `next.config.ts` 的配置，执行静态导出，并将产物输出到 `dist` 目录。
- **`"build:ext"`**: 一个自定义脚本，先运行 `build`，然后执行 `scripts/build-ext.mjs` 脚本，可能用于生成浏览器扩展相关的文件。

**结论**：`build` 脚本是生成兼容静态服务器产物的关键。它利用 `next.config.ts` 中的 `output: 'export'` 配置，生成一个无需服务器端渲染的纯静态网站。

**Section sources**

- [package.json](file://package.json#L5-L14)

## Nginx 部署配置

Nginx 是一个高性能的 HTTP 服务器和反向代理服务器，非常适合部署静态网站。

### 完整 Nginx 配置示例

```nginx
server {
    # 监听端口
    listen 80;
    listen [::]:80;
    server_name your-domain.com;

    # 根目录指向构建输出的 dist 目录
    root /path/to/your/one-nav/dist;
    index index.html;

    # 启用 gzip 压缩，减少传输体积
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;

    # 静态资源 MIME 类型优化
    location ~* \.(ico|css|js|gif|jpe?g|png|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # SPA 路由重写规则
    # 将所有非静态资源请求（如 /about, /settings）重写到 /index.html
    # 由前端路由处理，避免 404 错误
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 反向代理 API 请求（如果需要）
    # 如果应用有 API 路由，可以在此处代理到后端服务
    # location /api/ {
    #     proxy_pass http://localhost:8000/api/;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    # }
}
```

**配置说明：**

- **`root`**: 设置网站根目录为 `dist` 文件夹。
- **`gzip`**: 启用压缩，对文本类资源（CSS, JS, JSON）进行压缩，显著提升加载速度。
- **`location ~* \.(ico|css|js|...)$`**: 为静态资源（图片、字体、样式表、脚本）设置长期缓存（`expires 1y`）和 `immutable` 缓存头，浏览器会永久缓存这些文件，除非文件名改变。
- **`location /`**: 这是 SPA 的关键。`try_files $uri $uri/ /index.html;` 会尝试按顺序查找文件。如果请求的路径不是实际的文件或目录，则返回 `index.html`，让前端路由接管。

**Section sources**

- [dist/404.html](file://dist/404.html)
- [dist/\_next/static/chunks/981a7b3ba1dfa6bd.css](file://dist/_next/static/chunks/981a7b3ba1dfa6bd.css)
- [dist/\_next/static/chunks/9dd01691f16dbfdc.js](file://dist/_next/static/chunks/9dd01691f16dbfdc.js)

## Apache 部署配置

Apache 是另一个广泛使用的 Web 服务器，通过 `.htaccess` 文件可以轻松配置。

### .htaccess 重写规则

在 `dist` 目录的根目录下创建一个名为 `.htaccess` 的文件，并添加以下内容：

```apache
# 启用 mod_rewrite 模块
RewriteEngine On

# 设置文档根目录（可选，通常由虚拟主机配置）
# DocumentRoot /path/to/your/one-nav/dist

# SPA 路由重写规则
# 如果请求的文件或目录不存在，则重写到 index.html
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ /index.html [L]

# 静态资源缓存策略
# 为 CSS, JS, 图片等设置长期缓存
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType text/javascript "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType font/eot "access plus 1 year"
</IfModule>

# 启用 gzip 压缩
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/xml+rss
    AddOutputFilterByType DEFLATE application/json
</IfModule>
```

**配置说明：**

- **`RewriteEngine On`**: 必须启用 `mod_rewrite` 模块。
- **`RewriteCond` 和 `RewriteRule`**: 这是 SPA 的核心。`RewriteCond` 检查请求的文件 (`!-f`) 和目录 (`!-d`) 是否不存在。如果都不存在，则 `RewriteRule` 将所有请求重定向到 `/index.html`。
- **`<IfModule mod_expires.c>`**: 使用 `mod_expires` 模块为不同类型的静态资源设置 `Cache-Control` 和 `Expires` 头，实现长期缓存。
- **`<IfModule mod_deflate.c>`**: 使用 `mod_deflate` 模块启用 gzip 压缩。

**Section sources**

- [dist/404.html](file://dist/404.html)
- [dist/\_next/static/chunks/504003311425f84c.js](file://dist/_next/static/chunks/504003311425f84c.js)
- [dist/\_next/static/chunks/0bae3126c2213363.js](file://dist/_next/static/chunks/0bae3126c2213363.js)
- [dist/\_next/static/chunks/c78cbca517c49699.js](file://dist/_next/static/chunks/c78cbca517c49699.js)
